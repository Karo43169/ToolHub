@using ToolHub.Domain.Models
@inherits LayoutComponentBase
@inject ToolHub.State.ThemeState Theme
@inject ToolHub.State.ToolHubState HubState
@implements IDisposable
@inject ToolHub.State.CategoryState Categories

@* DODANE: *@
@using System.Security.Claims
@using Microsoft.Graph
@using Microsoft.AspNetCore.Components.Authorization
@inject GraphServiceClient Graph
@inject AuthenticationStateProvider AuthStateProvider

<div class="app-container">
    <div class="topbar">
        <div class="logo">
            <div class="logo-wrapper">
                <img src="logo.svg" class="company-logo" />
            </div>

            <span class="app-title">Tool Hub</span>
        </div>

        <div class="topbar-actions">
            <button class="icon-btn" @onclick="async () => await Theme.ToggleAsync()"
                    title="Toggle theme">
                <svg viewBox="0 0 24 24" class="icon">
                    <path fill="currentColor"
                          d="M12 3a9 9 0 100 18
                 9 9 0 000-18zm0 2
                 a7 7 0 010 14V5z" />
                </svg>
            </button>

            @* === ZMIANA: panel użytkownika / Login w prawym górnym rogu === *@
            <AuthorizeView>
                <Authorized Context="auth">
                    <div style="display:flex; align-items:center; gap:10px;">
                        @if (!string.IsNullOrEmpty(_photoDataUrl))
                        {
                            <img src="@_photoDataUrl"
                                 alt="profile"
                                 style="width:32px;height:32px;border-radius:50%;object-fit:cover;border:1px solid #5e70eb;" />
                        }
                        else
                        {
                            <div title="@GetDisplayName(auth.User)"
                                 style="width:32px;height:32px;border-radius:50%;
                                            background:#4F6BED;color:white;
                                            display:flex;align-items:center;justify-content:center;
                                            font-weight:600;">
                                @GetInitials(auth.User)
                            </div>
                        }

                        <div style="display:flex; flex-direction:column; line-height:1.1;">
                            <span style="font-size:14px; font-weight:600;">
                                @GetDisplayName(auth.User)
                            </span>
                            <span style="font-size:12px; color:#6b7280;">
                                @GetEmail(auth.User)
                            </span>
                        </div>
                    </div>
                </Authorized>

                <NotAuthorized>
                    <a class="top-btn" href="/MicrosoftIdentity/Account/SignIn">Login</a>
                </NotAuthorized>
            </AuthorizeView>
            @* === KONIEC ZMIANY === *@
        </div>
    </div>

    <div class="main-grid">
        <div class="left-panel">
            <h4>Filters</h4>

            <div class="filter-header">
                <button class="clear-btn" @onclick="HubState.ClearFilters">
                    Clear
                </button>
            </div>

            <div class="left-separator"></div>

            <div class="quick-actions">
                <button class="quick-btn @(HubState.CurrentSort == ToolHub.State.SortMode.LastUpdatedDesc ? "active" : "")"
                        @onclick="() => HubState.SetSort(ToolHub.State.SortMode.LastUpdatedDesc)"
                        title="Sort by last updated">
                    <span class="quick-icon">🔥</span>
                    <span>Last updated</span>
                </button>

                <button class="quick-btn" title="Favorites (requires auth)">
                    <span class="quick-icon">⭐</span>
                    <span>Favorites</span>
                </button>
            </div>

            <div class="filter-section">
                <div class="filter-title">Category</div>

                <button class="filter-item @(HubState.SelectedCategory is null ? "active" : "")"
                        @onclick="() => HubState.SetCategory(null)">
                    All
                </button>

                @foreach (var c in HubState.AvailableCategories)
                {
                    <button class="filter-item @(HubState.SelectedCategory == c ? "active" : "")"
                            @onclick="() => HubState.SetCategory(c)">
                        @c
                    </button>
                }
            </div>

            <div class="filter-section">
                <div class="filter-title">Status</div>

                <button class="filter-item @(HubState.SelectedStatus is null ? "active" : "")"
                        @onclick="() => HubState.SetStatus(null)">
                    All
                </button>

                @foreach (var s in HubState.AvailableStatuses)
                {
                    <button class="filter-item @(HubState.SelectedStatus == s ? "active" : "")"
                            @onclick="() => HubState.SetStatus(s)">
                        @s
                    </button>
                }
            </div>
        </div>


        <div class="center-panel">
            @Body
        </div>

        <div class="right-panel">
            <div class="details-content">
                <h4>Details</h4>

                @if (HubState.Selected is null)
                {
                    <div class="muted">Select a tool to see details.</div>
                }
                else
                {
                    <div class="details-title">@HubState.Selected.Name</div>
                    <div class="details-meta">
                        @HubState.Selected.Category · @HubState.Selected.Status · @HubState.Selected.Version
                    </div>

                    <div class="details-desc">@HubState.Selected.Description</div>

                    <div class="details-section">
                        <div class="details-label">Owner</div>
                        <div>@HubState.Selected.Owner</div>
                    </div>

                    <div class="details-section">
                        <div class="details-label">Tool location</div>
                        <div class="mono-wrap">@HubState.Selected.ToolFolderPath</div>
                    </div>

                    <div class="details-actions">
                        <button class="top-btn">Open location</button>
                    </div>

                    <div class="details-section">
                        <div class="details-label">Last update</div>
                        <div>@HubState.Selected.UpdatedByName · @HubState.Selected.UpdatedAtUtc.LocalDateTime</div>
                    </div>

                    <div class="details-section">
                        <div class="details-label">Tags</div>
                        <div class="tag-row">
                            @foreach (var tag in HubState.Selected.Tags)
                            {
                                <span class="tag">@tag</span>
                            }
                        </div>
                    </div>
                }
            </div>

            <div class="details-footer">
                <button class="top-btn" @onclick="OpenAdd">Add</button>

                @if (HubState.Selected != null)
                {
                    <button class="top-btn" @onclick="OpenEdit">Edit</button>
                    <button class="top-btn danger" @onclick="DeleteSelected">Delete</button>
                }
            </div>
        </div>
    </div>
</div>

@if (showModal)
{
    <div class="modal-overlay">
        <div class="modal-box">
            <h3>@(isEdit ? "Edit Tool" : "Add Tool")</h3>

            <div class="form-group">
                <label>Name</label>
                <input @bind="editName" />
            </div>

            <div class="form-group">
                <label>Category</label>
                <select @bind="editCategory">
                    @foreach (var c in Categories.Categories)
                    {
                        <option value="@c">@c</option>
                    }
                </select>
            </div>

            <div class="form-group">
                <label>Owner</label>
                <input @bind="editOwner" />
            </div>

            <div class="form-group">
                <label>Status</label>
                <select @bind="editStatus">
                    <option value="Active">Active</option>
                    <option value="Preview">Preview</option>
                    <option value="Deprecated">Deprecated</option>
                </select>
            </div>

            <div class="form-group">
                <label>Version</label>
                <input @bind="editVersion" placeholder="e.g. 1.0.0" />
            </div>

            <div class="form-group">
                <label>Description</label>
                <textarea @bind="editDescription"></textarea>
            </div>

            <div class="form-group">
                <label>Tags (comma separated)</label>
                <input @bind="editTags" placeholder="tag1, tag2, tag3" />
            </div>

            @if (isEdit && HubState.Selected is not null)
            {
                <div class="form-group">
                    <label>Tool folder</label>
                    <div class="readonly-box">@HubState.Selected.ToolFolderPath</div>
                </div>
            }

            <div class="modal-actions">
                <button class="top-btn" @onclick="Save">Save</button>
                <button class="top-btn" @onclick="() => showModal = false">Cancel</button>
            </div>
        </div>
    </div>
}

@code {
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Pobierz zdjęcie tylko gdy user jest zalogowany
            var state = await AuthStateProvider.GetAuthenticationStateAsync();
            if (state.User?.Identity?.IsAuthenticated == true)
            {
                await TryLoadProfilePhotoAsync();
            }
        }
    }

    private async Task TryLoadProfilePhotoAsync()
    {
        if (_photoLoaded) return;
        try
        {
            // Graph SDK v5 – bez .Request()
            using var stream = await Graph.Me.Photo.Content.GetAsync();
            if (stream != null)
            {
                using var ms = new MemoryStream();
                await stream.CopyToAsync(ms);
                var base64 = Convert.ToBase64String(ms.ToArray());
                _photoDataUrl = $"data:image/jpeg;base64,{base64}";
            }
        }
        catch
        {
            // brak zdjęcia lub brak uprawnień — pokaż inicjały
        }
        finally
        {
            _photoLoaded = true;
            StateHasChanged();
        }
    }

    private bool _photoLoaded = false;
    private string? _photoDataUrl;

    protected override void OnInitialized()
    {
        HubState.Changed += OnHubStateChanged;
    }

    private void OnHubStateChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        HubState.Changed -= OnHubStateChanged;
    }

    private bool showModal = false;
    private bool isEdit = false;

    private void OpenAdd()
    {
        isEdit = false;

        editName = "";
        editCategory = "";
        editOwner = "";
        editStatus = "Active";
        editVersion = "1.0.0";
        editDescription = "";
        editTags = "";

        showModal = true;
    }

    private void OpenEdit()
    {
        if (HubState.Selected is null)
            return;

        isEdit = true;

        editName = HubState.Selected.Name;
        editCategory = HubState.Selected.Category;
        editOwner = HubState.Selected.Owner;
        editStatus = HubState.Selected.Status;
        editVersion = HubState.Selected.Version;
        editDescription = HubState.Selected.Description;
        editTags = string.Join(", ", HubState.Selected.Tags);

        showModal = true;
    }

    private void DeleteSelected()
    {
        if (HubState.Selected != null)
            HubState.Delete(HubState.Selected.Id);
    }

    private string editName = "";
    private string editCategory = "";
    private string editOwner = "";
    private string editStatus = "Active";
    private string editVersion = "1.0.0";
    private string editDescription = "";
    private string editTags = "";

    private void Save()
    {
        if (string.IsNullOrWhiteSpace(editName))
            return;

        var tags = editTags
            .Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)
            .ToList();

        if (isEdit && HubState.Selected != null)
        {
            var updated = HubState.Selected with
            {
                Name = editName,
                Category = editCategory,
                Owner = editOwner,
                Status = editStatus,
                Version = editVersion,
                Description = editDescription,
                Tags = tags,
                UpdatedAtUtc = DateTimeOffset.UtcNow,
                UpdatedByName = "Dev User"
            };

            HubState.Update(updated);
        }
        else
        {
            var newId = Guid.NewGuid().ToString("N");
            var toolFolderPath = $"tools/{newId}";

            var newTool = new ToolEntry(
                Id: newId,
                Name: editName,
                Category: editCategory,
                Owner: editOwner,
                Status: editStatus,
                Version: editVersion,
                Description: editDescription,
                Tags: tags,
                ToolFolderPath: toolFolderPath,
                ManualPath: null,
                UpdatedAtUtc: DateTimeOffset.UtcNow,
                UpdatedByOid: "dev",
                UpdatedByName: "Dev User"
            );

            HubState.Add(newTool);
        }

        showModal = false;
    }

    // ===== Pomocnicze metody do wyświetlania danych użytkownika =====
    private static string GetDisplayName(ClaimsPrincipal user)
    {
        return user?.FindFirst("name")?.Value
               ?? user?.Identity?.Name
               ?? "User";
    }

    private static string GetEmail(ClaimsPrincipal user)
    {
        return user?.FindFirst("preferred_username")?.Value
               ?? user?.FindFirst(ClaimTypes.Email)?.Value
               ?? "";
    }

    private static string GetInitials(ClaimsPrincipal user)
    {
        var name = GetDisplayName(user)?.Trim() ?? "";
        if (string.IsNullOrEmpty(name)) return "?";

        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length == 1)
            return parts[0].Substring(0, Math.Min(2, parts[0].Length)).ToUpperInvariant();

        var c1 = parts[0].Length > 0 ? parts[0][0].ToString().ToUpperInvariant() : "";
        var c2 = parts[1].Length > 0 ? parts[1][0].ToString().ToUpperInvariant() : "";
        return $"{c1}{c2}";
    }
}